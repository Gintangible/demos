function showNumberWithAnimation(e,r,o){var a=$("#number-cell-"+e+"-"+r);a.css({backgroundColor:getNumberBackgroundColor(o),color:getNumberColor(o)}),a.text(o),a.animate({width:cellSideWidth,height:cellSideWidth,left:getPosLeft(e,r),top:getPosTop(e,r)},50)}function showMoveAnimation(e,r,o,a){$("#number-cell-"+e+"-"+r).animate({left:getPosLeft(o,a),top:getPosTop(o,a)},200)}function prepareForMobile(){documentWidth>500&&(gridContainer=500,cellSideWidth=100,cellSpace=20),$("#grid-container").css({width:gridContainer-2*cellSpace,height:gridContainer-2*cellSpace,padding:cellSpace,borderRadius:.02*cellSideWidth}),$(".grid-cell").css({width:cellSideWidth,height:cellSideWidth,borderRadius:.02*cellSideWidth})}function newGame(){init(),generateOneNumber(),generateOneNumber()}function init(){for(var e=0;e<4;e++)for(var r=0;r<4;r++){var o=$("#grid-cell-"+e+"-"+r);o.css({top:getPosTop(e,r),left:getPosLeft(e,r)})}for(var e=0;e<4;e++){board[e]=new Array,hasCrash[e]=new Array;for(var r=0;r<4;r++)board[e][r]=0,hasCrash[e][r]=!1}updataBoardView(),score=0}function updataBoardView(){$(".number-cell").remove();for(var e=0;e<4;e++)for(var r=0;r<4;r++){$("#grid-container").append('<div class="number-cell" id="number-cell-'+e+"-"+r+'"></div>');var o=$("#number-cell-"+e+"-"+r);0==board[e][r]?o.css({width:0,height:0,left:getPosLeft(e,r)+cellSideWidth/2,top:getPosTop(e,r)+cellSideWidth/2}):(o.css({width:cellSideWidth,height:cellSideWidth,left:getPosLeft(e,r),top:getPosTop(e,r),backgroundColor:getNumberBackgroundColor(board[e][r]),color:getNumberColor(board[e][r])}),o.text(board[e][r])),hasCrash[e][r]=!1}$(".number-cell").css({lineHeight:cellSideWidth+"px",fontSize:.6*cellSideWidth+"px"})}function generateOneNumber(){if(nospace(board))return!1;for(var e=parseInt(Math.floor(4*Math.random())),r=parseInt(Math.floor(4*Math.random())),o=0;o<50&&0!=board[e][r];){var e=parseInt(Math.floor(4*Math.random())),r=parseInt(Math.floor(4*Math.random()));o++}if(50==o)for(var a=0;a<4;a++)for(var t=0;t<4;t++)0==board[a][t]&&(e=a,r=t);var n=Math.random()<.5?2:4;return board[e][r]=n,showNumberWithAnimation(e,r,n),!0}function isgameover(){nospace(board)&&nomove(board)&&gameover()}function gameover(){alert("游戏结束！")}function moveLeft(){if(canMoveLeft(board)){for(var e=0;e<4;e++)for(var r=1;r<4;r++)if(0!=board[e][r])for(var o=0;o<r;o++)0==board[e][o]&&noBlockHorizontal(e,o,r,board)?(showMoveAnimation(e,r,e,o),board[e][o]=board[e][r],board[e][r]=0):board[e][o]!=board[e][r]||!noBlockHorizontal(e,o,r,board)||hasCrash[e][o]||(showMoveAnimation(e,r,e,o),board[e][o]*=2,board[e][r]=0,score+=board[e][o],updataScore(score),hasCrash[e][o]=!0);return setTimeout("updataBoardView()",200),!0}return!1}function moveRight(){if(!canMoveRight(board))return!1;for(var e=0;e<4;e++)for(var r=2;r>=0;r--)if(0!=board[e][r])for(var o=3;o>r;o--)0==board[e][o]&&noBlockHorizontal(e,r,o,board)?(showMoveAnimation(e,r,e,o),board[e][o]=board[e][r],board[e][r]=0):board[e][o]!=board[e][r]||!noBlockHorizontal(e,r,o,board)||hasCrash[e][o]||(showMoveAnimation(e,r,e,o),board[e][o]*=2,board[e][r]=0,score+=board[e][o],updataScore(score),hasCrash[e][o]=!0);return setTimeout("updataBoardView()",200),!0}function moveUp(){if(!canMoveUp(board))return!1;for(var e=0;e<4;e++)for(var r=1;r<4;r++)if(0!=board[r][e])for(var o=0;o<r;o++)0==board[o][e]&&noBlockVertical(e,o,r,board)?(showMoveAnimation(r,e,o,e),board[o][e]=board[r][e],board[r][e]=0):board[o][e]!=board[r][e]||!noBlockVertical(e,o,r,board)||hasCrash[o][e]||(showMoveAnimation(r,e,o,e),board[o][e]*=2,board[r][e]=0,score+=board[o][e],updataScore(score),hasCrash[o][e]=!0);return setTimeout("updataBoardView()",200),!0}function moveDown(){if(!canMoveDown(board))return!1;for(var e=0;e<4;e++)for(var r=2;r>=0;r--)if(0!=board[r][e])for(var o=3;o>r;o--)0==board[o][e]&&noBlockVertical(e,r,o,board)?(showMoveAnimation(r,e,o,e),board[o][e]=board[r][e],board[r][e]=0):board[o][e]!=board[r][e]||!noBlockVertical(e,r,o,board)||hasCrash[o][e]||(showMoveAnimation(r,e,o,e),board[o][e]*=2,board[r][e]=0,score+=board[o][e],updataScore(score),hasCrash[o][e]=!0);return setTimeout("updataBoardView()",200),!0}function getPosTop(e,r){return cellSpace+e*(cellSideWidth+cellSpace)}function getPosLeft(e,r){return cellSpace+r*(cellSideWidth+cellSpace)}function getNumberBackgroundColor(e){switch(e){case 2:return"#eee4da";case 4:return"#ede0c8";case 8:return"#f2b179";case 16:return"#f59563";case 32:return"#f67c5f";case 64:return"#f65e3b";case 128:return"#edcf72";case 256:return"#edcc61";case 512:return"#9c0";case 1024:return"#33b5e5";case 2048:return"#0099cc";case 4096:return"#aa66cc";case 8192:return"#9933cc"}return"black"}function getNumberColor(e){return e<=4?"#776e65":"white"}function nospace(e){for(var r=0;r<4;r++)for(var o=0;o<4;o++)if(0==e[r][o])return!1;return!0}function canMoveLeft(e){for(var r=0;r<4;r++)for(var o=1;o<4;o++)if(0!=e[r][o]&&(0==e[r][o-1]||e[r][o-1]==e[r][o]))return!0;return!1}function canMoveRight(e){for(var r=0;r<4;r++)for(var o=2;o>=0;o--)if(0!=e[r][o]&&(0==e[r][o+1]||e[r][o+1]==e[r][o]))return!0;return!1}function canMoveUp(e){for(var r=0;r<4;r++)for(var o=1;o<4;o++)if(0!=e[o][r]&&(0==e[o-1][r]||e[o-1][r]==e[o][r]))return!0;return!1}function canMoveDown(e){for(var r=0;r<4;r++)for(var o=2;o>=0;o--)if(0!=e[o][r]&&(0==e[o+1][r]||e[o+1][r]==e[o][r]))return!0;return!1}function noBlockHorizontal(e,r,o,a){for(var t=r+1;t<o;t++)if(0!=a[e][t])return!1;return!0}function noBlockVertical(e,r,o,a){for(var t=r+1;t<o;t++)if(0!=a[t][e])return!1;return!0}function nomove(e){return!(canMoveLeft(e)||canMoveRight(e)||canMoveDown(e)||canMoveUp(e))}function updataScore(e){$("#score").text(e)}var board=new Array,score=0,hasCrash=new Array,startx=0,starty=0,endx=0,endy=0;$(document).ready(function(){prepareForMobile(),newGame()}),$(document).keydown(function(e){switch(e.keyCode){case 37:moveLeft()&&(e.preventDefault(),setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300));break;case 38:moveUp()&&(e.preventDefault(),setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300));break;case 39:moveRight()&&(e.preventDefault(),setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300));break;case 40:moveDown()&&(e.preventDefault(),setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300))}}),document.addEventListener("touchstart",function(e){startx=e.touches[0].pageX,starty=e.touches[0].pageY}),document.addEventListener("touchend",function(e){endx=e.changedTouches[0].pageX,endy=e.changedTouches[0].pageY;var r=endx-startx,o=endy-starty;Math.abs(r)<.2*documentWidth&&Math.abs(o)<.2*documentWidth||(Math.abs(r)>=Math.abs(o)?r>0?moveRight()&&(setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300)):moveLeft()&&(setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300)):o>0?moveDown()&&(setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300)):moveUp()&&(setTimeout("generateOneNumber()",210),setTimeout("isgameover()",300)))}),documentWidth=window.screen.availWidth,gridContainer=.92*documentWidth,cellSideWidth=.18*documentWidth,cellSpace=.04*documentWidth;